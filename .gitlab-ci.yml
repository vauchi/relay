# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-relay
#
# WebSocket relay server
#
# Performance optimizations:
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Interruptible: Auto-cancel on new commits (via templates)
#
# GitLab Ultimate Features:
#   - SAST: Static application security testing
#   - Dependency Scanning: Cargo.lock vulnerability scanning
#   - Secret Detection: Prevent credential leaks
#   - Container Scanning: Docker image vulnerability scanning

# Shared templates + GitLab Ultimate Templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/mr-rules.yml'
      - '/ci-templates/reuse.yml'
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml

stages:
  - lint
  - test
  - security
  - build

variables:
  # GitLab Ultimate Security Configuration
  SAST_EXCLUDED_PATHS: "target/"
  DS_EXCLUDED_PATHS: "target/"
  SECRET_DETECTION_EXCLUDED_PATHS: "target/"

  # Container scanning for relay image
  CS_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

# ============================================================
# Lint Stage (change-based)
# ============================================================

lint:format:
  extends: [.rust-job, .validation-rust, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

lint:clippy:
  extends: [.rust-job, .validation-rust, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings
  allow_failure: true  # May fail on git dependency issues

# ============================================================
# Test Stage (change-based)
# ============================================================

test:unit:
  extends: [.rust-job, .validation-rust, .timeout-standard]
  stage: test
  needs: []
  script:
    - cargo test --all-targets
  allow_failure: true  # May fail on git dependency issues

test:coverage:
  extends: [.rust-job, .validation-rust, .timeout-standard]
  stage: test
  needs: []
  before_script:
    - rustup component add llvm-tools-preview
    - cargo install cargo-llvm-cov --locked || true
  script:
    - cargo llvm-cov --lcov --output-path lcov.info || true
    - cargo llvm-cov report || true
  coverage: '/Total:\s+(\d+(?:\.\d+)?%)/'
  artifacts:
    paths:
      - lcov.info
    expire_in: 1 week
  allow_failure: true

# ============================================================
# Security Stage (change-based)
# ============================================================

# GitLab security templates configuration
# Override child analyzer jobs (not parent stubs) to add tags and rules

semgrep-sast:
  tags: [docker]
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.rs"
          - ".gitlab-ci.yml"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Disable Gemnasium (doesn't support Cargo.lock well, use cargo-audit)
gemnasium-dependency_scanning:
  rules:
    - when: never

secret_detection:
  tags: [docker]
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"


# Rust-specific security (runs on dependency changes)
security:audit:
  extends: [.rust-job, .validation-deps, .timeout-quick]
  stage: security
  needs: []
  cache:
    policy: pull  # Read-only cache
  script:
    - cargo install cargo-audit || true
    - cargo audit
  allow_failure: true

# ============================================================
# Build Stage
# ============================================================

build:release:
  extends: [.rust-job, .timeout-standard]
  stage: build
  script:
    - cargo build --release
  artifacts:
    paths:
      - target/release/vauchi-relay
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

build:docker:
  extends: .timeout-standard
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
    - |
      if [ -n "$CI_REGISTRY_PASSWORD" ]; then
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
        docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
        docker push $CI_REGISTRY_IMAGE:latest
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  allow_failure: true
